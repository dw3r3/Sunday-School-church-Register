<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Main Register | Church Student Register</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>

<div class="container">
    <div class="sidebar-toggle" id="sidebarToggle">‚ò∞</div>

<aside class="sidebar" id="sidebar">
    <div class="sidebar-close" id="sidebarClose">&times;</div>
    <div class="logo-wrapper">
        <img src="{{ url_for('static', filename='images/logo.jpeg') }}" alt="Logo" class="logo" style="margin-bottom: 20px; margin-left: 0; height: 80px; width: 80px; border-radius: 50%;">
    </div>
        <h2 style="margin-bottom: 20px; color: #ffffff; font-size: 1.1rem; font-weight: 600;">Classes</h2>

        <div class="class-navigation">
            {% if session.get('role') == 'admin' %}
                <a href="{{ url_for('dashboard') }}" class="class-tab {{ 'active' if not selected_class else '' }}">üìã All Students</a>
                <a href="{{ url_for('dashboard', class_name='Genesis') }}" class="class-tab {{ 'active' if selected_class == 'Genesis' else '' }}">üå± Genesis</a>
                <a href="{{ url_for('dashboard', class_name='Exodus') }}" class="class-tab {{ 'active' if selected_class == 'Exodus' else '' }}">üö∂ Exodus</a>
                <a href="{{ url_for('dashboard', class_name='Psalms') }}" class="class-tab {{ 'active' if selected_class == 'Psalms' else '' }}">üéµ Psalms</a>
                <a href="{{ url_for('dashboard', class_name='Proverbs') }}" class="class-tab {{ 'active' if selected_class == 'Proverbs' else '' }}">üí° Proverbs</a>
                <a href="{{ url_for('dashboard', class_name='Revelation') }}" class="class-tab {{ 'active' if selected_class == 'Revelation' else '' }}">‚≠ê Revelation</a>
                <a href="{{ url_for('dashboard', class_name='High Schoolers') }}" class="class-tab {{ 'active' if selected_class == 'High Schoolers' else '' }}">üéì High School</a>
            {% elif session.get('role') == 'teacher' %}
                {% set assigned_class = session.get('assigned_class') %}
                <a href="{{ url_for('dashboard') }}" class="class-tab {{ 'active' if not selected_class else '' }}">üìã All Students</a>
                <a href="{{ url_for('dashboard', class_name='Genesis') }}"
                   class="class-tab {{ 'active' if selected_class == 'Genesis' else '' }} {{ 'my-class' if assigned_class == 'Genesis' else 'view-only' }}">
                   üå± Genesis {{ '(My Class)' if assigned_class == 'Genesis' else '(View Only)' }}
                </a>
                <a href="{{ url_for('dashboard', class_name='Exodus') }}"
                   class="class-tab {{ 'active' if selected_class == 'Exodus' else '' }} {{ 'my-class' if assigned_class == 'Exodus' else 'view-only' }}">
                   üö∂ Exodus {{ '(My Class)' if assigned_class == 'Exodus' else '(View Only)' }}
                </a>
                <a href="{{ url_for('dashboard', class_name='Psalms') }}"
                   class="class-tab {{ 'active' if selected_class == 'Psalms' else '' }} {{ 'my-class' if assigned_class == 'Psalms' else 'view-only' }}">
                   üéµ Psalms {{ '(My Class)' if assigned_class == 'Psalms' else '(View Only)' }}
                </a>
                <a href="{{ url_for('dashboard', class_name='Proverbs') }}"
                   class="class-tab {{ 'active' if selected_class == 'Proverbs' else '' }} {{ 'my-class' if assigned_class == 'Proverbs' else 'view-only' }}">
                   üí° Proverbs {{ '(My Class)' if assigned_class == 'Proverbs' else '(View Only)' }}
                </a>
                <a href="{{ url_for('dashboard', class_name='Revelation') }}"
                   class="class-tab {{ 'active' if selected_class == 'Revelation' else '' }} {{ 'my-class' if assigned_class == 'Revelation' else 'view-only' }}">
                   ‚≠ê Revelation {{ '(My Class)' if assigned_class == 'Revelation' else '(View Only)' }}
                </a>
                <a href="{{ url_for('dashboard', class_name='High Schoolers') }}"
                   class="class-tab {{ 'active' if selected_class == 'High Schoolers' else '' }} {{ 'my-class' if assigned_class == 'High Schoolers' else 'view-only' }}">
                   üéì High School {{ '(My Class)' if assigned_class == 'High Schoolers' else '(View Only)' }}
                </a>
            {% else %}
                <a href="{{ url_for('dashboard') }}" class="class-tab active">üìã All Students</a>
            {% endif %}
        </div>

        <div class="sidebar-links">
           <a href="{{ url_for('attendance_report') }}" class="sidebar-link">üìä Attendance Report</a>
           {% if session.get('role') == 'admin' %}
           <a href="{{ url_for('inventory') }}" class="sidebar-link">üì¶ Inventory</a>
           {% endif %}
        </div>

        <style>
        .class-navigation {
            display: flex;
            flex-direction: column;
            background: none;
            border-radius: 0;
            padding: 0;
            margin-bottom: 20px;
            gap: 6px;
        }

        .class-tab {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 12px 16px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #ffffff;
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .class-tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.2);
            color: #ffffff;
            text-decoration: none;
            transform: translateX(2px);
        }

        .class-tab.active {
            background: #000000;
            color: #ffffff;
            border: 1px solid #333333;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transform: translateX(2px);
        }

        .sidebar-links {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 10px;
        }

        .sidebar-link {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 12px 16px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #ffffff;
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sidebar-link:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #ffffff;
            text-decoration: none;
            transform: translateX(2px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Teacher class indicators */
        .class-tab.my-class {
            border-left: 4px solid #28a745;
            font-weight: 600;
        }

        .class-tab.view-only {
            opacity: 0.8;
            font-style: italic;
        }

        .class-tab.view-only:hover {
            opacity: 1;
        }

        /* Disabled attendance checkboxes for view-only mode */
        .attendance-checkbox:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .attendance-checkbox:disabled:hover {
            opacity: 0.7;
        }

        /* Past Sunday styling */
        .past-sunday {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        .past-sunday .attendance-checkbox {
            opacity: 0.6;
        }
        </style>
    </aside>

    <main class="register">
           {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="flash {{ category }}">{{ message }}</div>
    {% endfor %}
  {% endif %}
{% endwith %}

        <div style="text-align: right;">
            <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
        </div>

        <style>
        .logout-btn {
            color: #ffffff;
            background-color: #D32F2F;
            border-radius: 25px;
            padding: 10px 20px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(211, 47, 47, 0.3);
            display: inline-block;
        }

        .logout-btn:hover {
            background-color: #B71C1C;
            color: #ffffff;
            text-decoration: none;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(211, 47, 47, 0.4);
        }

        /* New Student Form Styles */
        .student-form {
            max-width: 600px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-input.has-error {
            border-color: #dc3545;
        }

        .form-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
        }

        .form-section h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1.1rem;
        }

        .form-help {
            color: #666;
            margin: 0 0 15px 0;
            font-size: 0.9rem;
        }

        .form-row {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .form-group-half {
            flex: 1;
            margin-bottom: 0;
        }

        .form-divider {
            position: relative;
            text-align: center;
            padding: 20px 0;
        }

        .form-divider span {
            background: #f8f9fa;
            padding: 8px;
            color: #666;
            font-weight: 600;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #e9ecef;
        }

        .field-help {
            display: block;
            color: #666;
            font-size: 0.85rem;
            margin-top: 5px;
        }

        .required {
            color: #dc3545;
        }

        .validation-message {
            color: #dc3545;
            font-size: 0.9rem;
            margin: 10px 0 0 0;
            min-height: 20px;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 10px;
            }

            .form-divider {
                padding: 10px 0;
            }
        }
        </style>
    <!--The below code allows us to display a logo inside-->
<!--
        <div class="logo-wrapper">
            <img src="{{ url_for('static', filename='images/logo.jpeg') }}" alt="Logo" class="logo" style="margin-bottom: 20px; margin-left: 0;">
        </div> -->

        <h1>
            {% if selected_class %}
                {{ selected_class }} Class - 
            {% endif %}
            Student Register - {{ month }}/{{ year }}
        </h1>

        <form method="get">
            <input type="hidden" name="class_name" value="{{ selected_class }}">
            <label>Month:
                <select name="month" onchange="this.form.submit()">
                    {% for m in range(1, 13) %}
                        <option value="{{ m }}" {% if m == month %}selected{% endif %}>{{ m }}</option>
                    {% endfor %}
                </select>
            </label>

            <label>Year:
                <select name="year" onchange="this.form.submit()">
                    {% for y in range(2023, 2036) %}
                        <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
            </label>
        </form>
        <a href="{{ url_for('all_students') }}" style="padding: 5px 10px; background: #333; color: white; border-radius: 5px; text-decoration: none;">
    All Students
</a>


        <p><strong>Present on {{ current_sunday.strftime('%B %d, %Y') }}:</strong> <span id="presentCount">0</span></p>

        <!-- Month Navigation Info -->
        <div style="background: #e8f5e8; border: 1px solid #c3e6c3; border-radius: 6px; padding: 12px; margin-bottom: 15px; font-size: 0.9rem;">
            <i class="fas fa-info-circle" style="color: #28a745; margin-right: 8px;"></i>
            <strong>Note:</strong> All students are shown regardless of the selected month.
            Past Sundays are read-only and cannot be edited.
        </div>
        <!-- Attendance Warning (Admin Only) -->
        {% if session["role"] == "admin" and at_risk_count > 0 %}
        <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-exclamation-triangle" style="color: #856404; font-size: 1.2rem;"></i>
                <div>
                    <strong style="color: #856404;">Attendance Alert:</strong>
                    <span style="color: #856404;">{{ at_risk_count }} student{{ 's' if at_risk_count != 1 else '' }} at risk of auto-deactivation for missing 3+ Sundays.</span>
                </div>
                <a href="{{ url_for('manage_status') }}" style="background: #ffc107; color: #212529; padding: 8px 16px; border-radius: 6px; text-decoration: none; font-weight: 600; margin-left: auto;">
                    Review Now
                </a>
            </div>
        </div>
        {% endif %}

        <!-- Teacher View Only Notice -->
        {% if session.get('role') == 'teacher' and selected_class and session.get('assigned_class') != selected_class %}
        <div style="background: #e3f2fd; border: 1px solid #bbdefb; border-radius: 8px; padding: 15px; margin-bottom: 20px; border-left: 4px solid #2196f3;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-eye" style="color: #1976d2; font-size: 1.2rem;"></i>
                <div>
                    <strong style="color: #1976d2;">Viewing {{ selected_class }} Class (Read-Only)</strong>
                    <p style="margin: 5px 0 0 0; color: #1565c0; font-size: 0.9rem;">
                        You can view student details but cannot mark attendance or edit students.
                        Your assigned class is: <strong>{{ session.get('assigned_class') }}</strong>
                    </p>
                </div>
            </div>
        </div>
        {% endif %}

        <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
            <button id="openModalBtn">+ New Student</button>
            {% if session["role"] == "admin" %}
            <a href="{{ url_for('promote_students') }}" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 600;">
                <i class="fas fa-graduation-cap"></i> Class Promotions
            </a>
            <a href="{{ url_for('manage_status') }}" style="background: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 600;">
                <i class="fas fa-user-check"></i> Manage Status
            </a>
            <a href="{{ url_for('admin_teachers') }}" style="background: #6f42c1; color: white; border: none; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 600;">
                <i class="fas fa-users-cog"></i> Teacher Management
            </a>
            <a href="{{ url_for('backup_restore') }}" style="background: #e67e22; color: white; border: none; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 600;">
                <i class="fas fa-database"></i> Backup & Restore
            </a>
            {% endif %}
        </div>

        <div style="display:flex;gap:8px;align-items:center;margin-bottom:15px;flex-wrap:wrap;">
            <input type="text" id="searchInput" placeholder="Search student by name..." style="padding: 8px; width: 100%; max-width: 360px; border-radius: 5px; border: 1px solid #ccc;">

            <input type="text" id="familySearchInput" placeholder="Search by family number" value="{{ family_id or '' }}" style="padding:8px;border-radius:5px;border:1px solid #ccc;width:200px;">
        </div>

        <table id="studentTable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Age</th>
                    <th>Status</th>
                    {% for sunday in sundays %}
                        <th style="{% if sunday < now().date() %}color: #6c757d; font-style: italic;{% endif %}">
                            {{ sunday.strftime('%d %b') }}
                            {% if sunday < now().date() %}<br><small>(Past)</small>{% endif %}
                        </th>
                    {% endfor %}
                    {% if session["role"] == "teacher" %}
                        <th>Action</th>
                    {% endif %}
                    {% if session["role"] == "admin" %}
                        <th>Actions</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
    {% for student in students %}
    <tr {% if student.deletion_requested %} style="background-color: #eee; color: gray;" {% endif %}>
        <td>
            <div style="display: flex; align-items: center; gap: 10px;">
                {% if student.profile_image %}
                    <img src="{{ url_for('static', filename='uploads/profiles/' + student.profile_image) }}"
                         alt="{{ student.name }}"
                         onclick="showLargeImage('{{ url_for('static', filename='uploads/profiles/' + student.profile_image) }}')"
                         style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #ddd; cursor: pointer; transition: transform 0.2s;"
                         onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                {% else %}
                    <div onclick="viewStudent({{ student.id }})" style="width: 40px; height: 40px; border-radius: 50%; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border: 2px solid #ddd; font-size: 18px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#e0e0e0'" onmouseout="this.style.background='#f0f0f0'">
                        üë§
                    </div>
                {% endif %}
                <div>
                    {{ student.name }}
                    {% if student.family_id %}
                        <br><small style="color: #666;">Family: {{ student.family_id }}</small>
                    {% endif %}
                    {% if student.deletion_requested %}
                        <br><small><em>Pending Admin Deletion</em></small>
                    {% endif %}
                </div>
            </div>
        </td>
        <td>
            {% set birth = student.dob | todatetime %}
            {% set age = ((now() - birth).days // 365) %}
            {{ age }}
        </td>
        <td>
            <span style="padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 500;
                         background: {{ '#d4edda' if student.status == 'active' else '#f8d7da' }};
                         color: {{ '#155724' if student.status == 'active' else '#721c24' }};">
                {{ 'Active' if student.status == 'active' else 'Inactive' }}
            </span>
        </td>
        {% for sunday in sundays %}
  {% if not student.deletion_requested and student.status == "active" %}
  <td>
    {% set is_past_sunday = sunday < now().date() %}
    {% set is_other_class = session.get('role') == 'teacher' and session.get('assigned_class') != student.student_class %}
    <input type="checkbox"
           class="attendance-checkbox"
           data-sid="{{ student.id }}"
           data-date="{{ sunday.strftime('%Y-%m-%d') }}"
           {% if attendance_present(student.id, sunday) %} checked {% endif %}
           {% if is_past_sunday or is_other_class %} disabled
           title="{% if is_past_sunday %}This Sunday has passed - attendance cannot be modified{% elif is_other_class %}You can only mark attendance for your assigned class ({{ session.get('assigned_class') }}){% endif %}" {% endif %}>
  </td>
{% else %}
  <td></td>
{% endif %}

        {% endfor %}

        <td>
            {% if session["role"] == "teacher" and not student.deletion_requested and session.get('assigned_class') == student.student_class %}
                <form action="{{ url_for('mark_for_deletion', student_id=student.id) }}" method="POST">
            <button type="submit" title="Request Deletion" style="background: transparent; border: none; color: rgb(0, 0, 0); cursor: pointer;">
                <i class="fas fa-trash"></i>
            </button>
                </form>
            {% elif session["role"] == "teacher" and not student.deletion_requested and session.get('assigned_class') != student.student_class %}
                <span style="color: #6c757d; font-style: italic; font-size: 0.9rem;">View Only</span>

            {% elif session["role"] == "admin" and student.deletion_requested %}
                <form action="{{ url_for('approve_delete', student_id=student.id) }}" method="POST" style="display:inline;">
                    <button type="submit" style="background: green; color: white; border: none; padding: 5px 10px; cursor: pointer;">‚úî Approve</button>
                </form>
                <form action="{{ url_for('reject_delete', student_id=student.id) }}" method="POST" style="display:inline;">
                    <button type="submit" style="background: orange; color: white; border: none; padding: 5px 10px; cursor: pointer;">‚úñ Reject</button>
                </form>
            {% elif session["role"] == "admin" and not student.deletion_requested %}
                <button onclick="deleteStudent({{ student.id }}, '{{ student.name }}')"
                        title="Delete Student Permanently"
                        style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 5px;">
                    <i class="fas fa-trash"></i> Delete
                </button>
            {% endif %}
        </td>





        </td>
                <td>
          <a href="{{ url_for('student_detail', student_id=student.id) }}"
             style="color: #28a745; text-decoration: none;">
             <i class="fas fa-eye"></i> <!-- or üëÅÔ∏è -->
          </a>
        </td>

    </tr>
    {% endfor %}
</tbody>

        </table>
    </main>
</div>

<!-- Modal for New Student -->
<div id="newStudentModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>Register New Student</h2>
    <form action="{{ url_for('add_student') }}" method="POST" enctype="multipart/form-data" id="newStudentForm" class="student-form">
        <div class="form-group">
            <label class="form-label" for="nameInput">Full Name <span class="required">*</span></label>
            <input type="text" name="name" id="nameInput" class="form-input" required placeholder="Student's full name">
        </div>

        <div class="form-section">
            <h3>Age Information</h3>
            <p class="form-help">Enter either date of birth or age - the system will automatically calculate the appropriate class.</p>
            
            <div class="form-row">
                <div class="form-group form-group-half">
                    <label class="form-label" for="dobInput">Date of Birth</label>
                    <input type="date" name="dob" id="dobInput" class="form-input" max="{{ now().strftime('%Y-%m-%d') }}">
                    <small class="field-help">Select the student's birth date</small>
                </div>

                <div class="form-divider">
                    <span>OR</span>
                </div>

                <div class="form-group form-group-half">
                    <label class="form-label" for="ageInput">Age</label>
                    <input type="number" name="age" id="ageInput" class="form-input" min="0" max="120" placeholder="Years">
                    <small class="field-help">Enter current age in years</small>
                </div>
            </div>
            <p class="validation-message" id="ageValidationMsg"></p>
        </div>

        <div class="form-group">
            <label class="form-label" for="parentInput">Parent/Guardian</label>
            <input type="text" name="parent" id="parentInput" class="form-input" placeholder="Parent or guardian's name">
        </div>

        <div class="form-group">
            <label class="form-label" for="contactInput">Emergency Contact</label>
            <input type="text" name="contact" id="contactInput" class="form-input" placeholder="Phone number or email">
        </div>

        <div class="form-group">
            <label class="form-label" for="familyInput">Family ID</label>
            <input type="text" name="family_id" id="familyInput" class="form-input" placeholder="Optional - for grouping siblings">
            <small class="field-help">Use this to group siblings together</small>
        </div>
        <label style="display: block; margin: 10px 0; font-weight: 500;">Profile Photo (optional):</label>
        <input type="file" name="profile_image" accept="image/*" style="margin-bottom: 15px;"><br>
        <button type="submit">Register</button>
    </form>
  </div>
</div>

<!-- JS Scripts -->
<script>

    setTimeout(() => {
    document.querySelectorAll('.flash').forEach(flash => {
      flash.style.transition = "opacity 0.5s ease-out";
      flash.style.opacity = "0";
      setTimeout(() => flash.remove(), 500); // Remove it completely
    });
  }, 1000); // Show for 4 seconds

    document.querySelectorAll('.attendance-checkbox').forEach(cb => {
    cb.addEventListener('change', function () {
        // Check if this checkbox is disabled (past Sunday or other class)
        if (this.disabled) {
            // Revert the change
            this.checked = !this.checked;
            alert('This attendance cannot be modified. ' + this.title);
            return;
        }

        const studentId = this.dataset.sid;
        const date = this.dataset.date;
        const present = this.checked;

        // Check if the date is in the past
        const today = new Date();
        const attendanceDate = new Date(date);
        today.setHours(0, 0, 0, 0);
        attendanceDate.setHours(0, 0, 0, 0);

        if (attendanceDate < today) {
            // Revert the change
            this.checked = !this.checked;
            alert('Cannot modify attendance for past Sundays.');
            return;
        }

        fetch('/mark_attendance', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `student_id=${studentId}&date=${date}&present=${present}`
        });
    });
});

    const checkboxes = document.querySelectorAll('.attendance-checkbox');
    const presentCounter = document.getElementById('presentCount');
    const currentSunday = '{{ current_sunday.strftime("%Y-%m-%d") }}';

    function updatePresentCount() {
        // Only count checkboxes for the current Sunday
        const todayCheckboxes = [...checkboxes].filter(cb => cb.dataset.date === currentSunday);
        const count = todayCheckboxes.filter(cb => cb.checked).length;
        presentCounter.textContent = count;
    }
    updatePresentCount();

    checkboxes.forEach(cb => {
        cb.addEventListener('change', updatePresentCount);
    });

    const modal = document.getElementById("newStudentModal");
    const btn = document.getElementById("openModalBtn");
    const span = document.getElementsByClassName("close")[0];

    btn.onclick = () => { modal.style.display = "block"; }
    span.onclick = () => { modal.style.display = "none"; }
    
    // Enhanced form validation and field interaction
    const dobInput = document.getElementById('dobInput');
    const ageInput = document.getElementById('ageInput');
    const validationMsg = document.getElementById('ageValidationMsg');

    function calculateAge(birthDate) {
        const today = new Date();
        const birth = new Date(birthDate);
        let age = today.getFullYear() - birth.getFullYear();
        const monthDiff = today.getMonth() - birth.getMonth();
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
            age--;
        }
        return age;
    }

    function handleDOBInput() {
        if (dobInput.value) {
            const age = calculateAge(dobInput.value);
            if (age < 0) {
                dobInput.classList.add('has-error');
                validationMsg.textContent = 'Date of birth cannot be in the future';
                ageInput.disabled = true;
            } else {
                dobInput.classList.remove('has-error');
                validationMsg.textContent = `Age based on DOB: ${age} years`;
                ageInput.value = '';
                ageInput.disabled = true;
            }
        } else {
            dobInput.classList.remove('has-error');
            validationMsg.textContent = '';
            ageInput.disabled = false;
        }
    }

    function handleAgeInput() {
        if (ageInput.value) {
            const age = parseInt(ageInput.value, 10);
            if (isNaN(age) || age < 0 || age > 120) {
                ageInput.classList.add('has-error');
                validationMsg.textContent = 'Please enter a valid age between 0 and 120';
                dobInput.disabled = true;
            } else {
                ageInput.classList.remove('has-error');
                validationMsg.textContent = '';
                dobInput.value = '';
                dobInput.disabled = true;
            }
        } else {
            ageInput.classList.remove('has-error');
            validationMsg.textContent = '';
            dobInput.disabled = false;
        }
    }

    dobInput.addEventListener('input', handleDOBInput);
    ageInput.addEventListener('input', handleAgeInput);

    // Form submission validation
    document.getElementById('newStudentForm').addEventListener('submit', function(e) {
        const dob = dobInput.value.trim();
        const age = ageInput.value.trim();
        
        if (!dob && !age) {
            e.preventDefault();
            validationMsg.textContent = 'Please provide either a date of birth or an age';
            dobInput.classList.add('has-error');
            ageInput.classList.add('has-error');
            return false;
        }

        // Clear any validation styling
        dobInput.classList.remove('has-error');
        ageInput.classList.remove('has-error');
        validationMsg.textContent = '';
    });
    window.onclick = (event) => {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    // Search inputs
    const searchInput = document.getElementById("searchInput");
    const familySearchInput = document.getElementById("familySearchInput");
    const rows = document.querySelectorAll("#studentTable tbody tr");

    function filterTable() {
        const nameFilter = searchInput.value.toLowerCase();
        const familyFilter = familySearchInput.value.toLowerCase();
        
        rows.forEach(row => {
            const nameCell = row.querySelector("td");
            const name = nameCell.textContent.toLowerCase();
            const familyText = nameCell.querySelector('small')?.textContent.toLowerCase() || '';
            
            const matchesName = nameFilter === '' || name.includes(nameFilter);
            const matchesFamily = familyFilter === '' || familyText.includes(`family: ${familyFilter}`);
            
            row.style.display = (matchesName && matchesFamily) ? "" : "none";
        });
    }

    // Add listeners to both inputs
    searchInput.addEventListener("keyup", filterTable);
    familySearchInput.addEventListener("keyup", filterTable);

// ...existing code...
const toggleBtn = document.getElementById("sidebarToggle");
const sidebar = document.getElementById("sidebar");
const sidebarClose = document.getElementById("sidebarClose");

toggleBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    sidebar.classList.add("active");
});

sidebarClose.addEventListener("click", (e) => {
    e.stopPropagation();
    sidebar.classList.remove("active");
});

// Only close sidebar if click is outside both sidebar and toggle button
document.addEventListener("mousedown", function (e) {
    if (
        sidebar.classList.contains("active") &&
        !sidebar.contains(e.target) &&
        e.target !== toggleBtn
    ) {
        sidebar.classList.remove("active");
    }
});

// Edit Student functionality (now includes view details)
function editStudent(studentId) {
    // Fetch student data
    fetch(`/get_student/${studentId}`)
        .then(response => response.json())
        .then(student => {
            // Calculate age
            const age = new Date().getFullYear() - new Date(student.dob).getFullYear();

            // Populate view section
            const photoDisplay = document.getElementById('studentPhotoDisplay');
            if (student.profile_image) {
                photoDisplay.innerHTML = `
                    <img src="/static/uploads/profiles/${student.profile_image}"
                         onclick="showLargeImage('/static/uploads/profiles/${student.profile_image}')"
                         style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid #ddd; cursor: pointer; transition: transform 0.2s;"
                         onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                `;
            } else {
                photoDisplay.innerHTML = '<div style="width: 120px; height: 120px; border-radius: 50%; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border: 3px solid #ddd; font-size: 50px; margin: 0 auto;">üë§</div>';
            }

            // Populate info display
            const infoDisplay = document.getElementById('studentInfoDisplay');
            infoDisplay.innerHTML = `
                <h3 style="margin: 15px 0; color: #333; text-align: center;">${student.name}</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 0.95rem;">
                    <div><strong>Age:</strong> ${age} years old</div>
                    <div><strong>Class:</strong> ${student.student_class}</div>
                    <div><strong>Date of Birth:</strong> ${new Date(student.dob).toLocaleDateString()}</div>
                    <div><strong>Family ID:</strong> ${student.family_id || 'Not set'}</div>
                    <div><strong>Parent/Guardian:</strong> ${student.parent || 'Not provided'}</div>
                    <div><strong>Contact:</strong> ${student.contact || 'Not provided'}</div>
                </div>
            `;

            // Populate edit form
            document.getElementById('editStudentId').value = student.id;
            document.getElementById('editStudentName').value = student.name;
            document.getElementById('editStudentDob').value = student.dob;
            document.getElementById('editStudentParent').value = student.parent || '';
            document.getElementById('editStudentContact').value = student.contact || '';
            document.getElementById('editStudentFamilyId').value = student.family_id || '';

            // Show current photo in edit section
            const photoDiv = document.getElementById('currentPhoto');
            if (student.profile_image) {
                photoDiv.innerHTML = `<img src="/static/uploads/profiles/${student.profile_image}" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid #ddd;">`;
            } else {
                photoDiv.innerHTML = '<div style="width: 80px; height: 80px; border-radius: 50%; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border: 2px solid #ddd; font-size: 30px;">üë§</div>';
            }

            document.getElementById('editStudentModal').style.display = 'block';
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading student data');
        });
}

function closeEditModal() {
    document.getElementById('editStudentModal').style.display = 'none';
}



function showLargeImage(imageSrc) {
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center; cursor: pointer;';

    const img = document.createElement('img');
    img.src = imageSrc;
    img.style.cssText = 'max-width: 90%; max-height: 90%; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.5);';

    modal.appendChild(img);
    document.body.appendChild(modal);

    modal.onclick = () => document.body.removeChild(modal);
}

// Edit modal close functionality
const editClose = document.getElementsByClassName("edit-close")[0];
editClose.onclick = function() {
    closeEditModal();
}

window.onclick = function(event) {
    if (event.target == document.getElementById("editStudentModal")) {
        closeEditModal();
    }
}

// Delete Student function (Admin only)
function deleteStudent(studentId, studentName) {
    if (confirm(`Are you sure you want to permanently delete "${studentName}"?\n\nThis action cannot be undone and will remove:\n- Student record\n- All attendance history\n- Profile photo\n\nClick OK to confirm deletion.`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/delete-student/${studentId}`;

        // Add CSRF protection if needed
        const csrfToken = document.querySelector('meta[name="csrf-token"]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfToken.getAttribute('content');
            form.appendChild(csrfInput);
        }

        document.body.appendChild(form);
        form.submit();
    }
}

</script>

<!-- Edit Student Modal -->
<div id="editStudentModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <span class="edit-close">&times;</span>
        <h2 style="margin-bottom: 20px; color: #333;">üë§ Student Details & Edit</h2>

        <!-- Student Details View Section -->
        <div id="studentDetailsView" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 25px; text-align: center;">
            <div id="studentPhotoDisplay" style="margin-bottom: 15px;">
                <!-- Photo will be populated by JavaScript -->
            </div>
            <div id="studentInfoDisplay" style="text-align: left; max-width: 400px; margin: 0 auto;">
                <!-- Student info will be populated by JavaScript -->
            </div>
        </div>

        <!-- Edit Form Section -->
        <div style="border-top: 2px solid #e9ecef; padding-top: 25px;">
            <h3 style="margin-bottom: 15px; color: #333;">‚úèÔ∏è Edit Information</h3>
            <form method="POST" action="{{ url_for('edit_student') }}" enctype="multipart/form-data" id="editStudentForm">
            <input type="hidden" name="student_id" id="editStudentId">

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Full Name:</label>
                <input type="text" name="name" id="editStudentName" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Date of Birth:</label>
                <input type="date" name="dob" id="editStudentDob" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Parent/Guardian:</label>
                <input type="text" name="parent" id="editStudentParent" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Contact:</label>
                <input type="text" name="contact" id="editStudentContact" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Family ID:</label>
                <input type="text" name="family_id" id="editStudentFamilyId" placeholder="Optional - for grouping siblings" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Profile Photo:</label>
                <div id="currentPhoto" style="margin-bottom: 10px;"></div>
                <input type="file" name="profile_image" accept="image/*" style="width: 100%; padding: 10px; border: 2px dashed #ddd; border-radius: 6px; background: #f9f9f9;">
                <small style="color: #666;">Leave blank to keep current photo</small>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" onclick="closeEditModal()" style="padding: 12px 24px; border: 1px solid #ddd; background: white; border-radius: 8px; cursor: pointer; font-weight: 500;">Cancel</button>
                <button type="submit" style="padding: 12px 24px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">‚úèÔ∏è Update Student</button>
            </div>
        </form>
    </div>
</div>





</body>
</html>
